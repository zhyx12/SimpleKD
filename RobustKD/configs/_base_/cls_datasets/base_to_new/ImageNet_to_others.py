#
# ----------------------------------------------
label_transform_for_A = [6,
                         11,
                         13,
                         15,
                         17,
                         22,
                         23,
                         27,
                         30,
                         37,
                         39,
                         42,
                         47,
                         50,
                         57,
                         70,
                         71,
                         76,
                         79,
                         89,
                         90,
                         94,
                         96,
                         97,
                         99,
                         105,
                         107,
                         108,
                         110,
                         113,
                         124,
                         125,
                         130,
                         132,
                         143,
                         144,
                         150,
                         151,
                         207,
                         234,
                         235,
                         254,
                         277,
                         283,
                         287,
                         291,
                         295,
                         298,
                         301,
                         306,
                         307,
                         308,
                         309,
                         310,
                         311,
                         313,
                         314,
                         315,
                         317,
                         319,
                         323,
                         324,
                         326,
                         327,
                         330,
                         334,
                         335,
                         336,
                         347,
                         361,
                         363,
                         372,
                         378,
                         386,
                         397,
                         400,
                         401,
                         402,
                         404,
                         407,
                         411,
                         416,
                         417,
                         420,
                         425,
                         428,
                         430,
                         437,
                         438,
                         445,
                         456,
                         457,
                         461,
                         462,
                         470,
                         472,
                         483,
                         486,
                         488,
                         492,
                         496,
                         514,
                         516,
                         528,
                         530,
                         539,
                         542,
                         543,
                         549,
                         552,
                         557,
                         561,
                         562,
                         569,
                         572,
                         573,
                         575,
                         579,
                         589,
                         606,
                         607,
                         609,
                         614,
                         626,
                         627,
                         640,
                         641,
                         642,
                         643,
                         658,
                         668,
                         677,
                         682,
                         684,
                         687,
                         701,
                         704,
                         719,
                         736,
                         745,
                         748,
                         751,
                         757,
                         762,
                         764,
                         767,
                         772,
                         773,
                         775,
                         778,
                         779,
                         785,
                         791,
                         796,
                         801,
                         802,
                         803,
                         812,
                         814,
                         819,
                         822,
                         830,
                         832,
                         834,
                         837,
                         843,
                         845,
                         848,
                         857,
                         860,
                         868,
                         877,
                         878,
                         886,
                         888,
                         895,
                         898,
                         905,
                         911,
                         922,
                         930,
                         931,
                         932,
                         935,
                         941,
                         943,
                         945,
                         949,
                         952,
                         954,
                         955,
                         957,
                         969,
                         970,
                         978,
                         979,
                         982,
                         984,
                         985,
                         986]

label_transform_for_R = [1,
                         2,
                         4,
                         6,
                         8,
                         9,
                         11,
                         13,
                         22,
                         23,
                         26,
                         29,
                         31,
                         39,
                         47,
                         63,
                         71,
                         76,
                         79,
                         84,
                         90,
                         94,
                         96,
                         97,
                         99,
                         100,
                         105,
                         107,
                         113,
                         122,
                         125,
                         130,
                         132,
                         144,
                         145,
                         147,
                         148,
                         150,
                         151,
                         155,
                         160,
                         161,
                         162,
                         163,
                         171,
                         172,
                         178,
                         187,
                         195,
                         199,
                         203,
                         207,
                         208,
                         219,
                         231,
                         232,
                         234,
                         235,
                         242,
                         245,
                         247,
                         250,
                         251,
                         254,
                         259,
                         260,
                         263,
                         265,
                         267,
                         269,
                         276,
                         277,
                         281,
                         288,
                         289,
                         291,
                         292,
                         293,
                         296,
                         299,
                         301,
                         308,
                         309,
                         310,
                         311,
                         314,
                         315,
                         319,
                         323,
                         327,
                         330,
                         334,
                         335,
                         337,
                         338,
                         340,
                         341,
                         344,
                         347,
                         353,
                         355,
                         361,
                         362,
                         365,
                         366,
                         367,
                         368,
                         372,
                         388,
                         390,
                         393,
                         397,
                         401,
                         407,
                         413,
                         414,
                         425,
                         428,
                         430,
                         435,
                         437,
                         441,
                         447,
                         448,
                         457,
                         462,
                         463,
                         469,
                         470,
                         471,
                         472,
                         476,
                         483,
                         487,
                         515,
                         546,
                         555,
                         558,
                         570,
                         579,
                         583,
                         587,
                         593,
                         594,
                         596,
                         609,
                         613,
                         617,
                         621,
                         629,
                         637,
                         657,
                         658,
                         701,
                         717,
                         724,
                         762,
                         767,
                         773,
                         775,
                         778,
                         779,
                         786,
                         804,
                         811,
                         814,
                         819,
                         823,
                         832,
                         845,
                         850,
                         864,
                         873,
                         881,
                         887,
                         893,
                         905,
                         926,
                         929,
                         930,
                         931,
                         932,
                         934,
                         935,
                         941,
                         943,
                         945,
                         946,
                         947,
                         949,
                         951,
                         952,
                         955,
                         961,
                         963,
                         965,
                         978,
                         979,
                         981,
                         986]

double_dataset_type = 'ssda_cls_double_dataset'
triple_dataset_type = 'ssda_cls_triple_dataset'
single_dataset_type = 'ssda_cls_dataset'
source_domain = 'imagenetdg_imagenettrain'
target_domain_1 = 'imagenetdg_imageneta'
target_domain_2 = 'imagenetdg_imagenetr'
target_domain_3 = 'imagenetdg_imagenets'
target_domain_4 = 'imagenetdg_imagenetv2'
target_domain_5 = 'imagenetdg_imagenetval'

img_norm_cfg = dict(
    # mean=[123.675, 116.28, 103.53],
    # std=[58.395, 57.12, 57.375],
    mean=[122.771, 116.746, 104.093],
    std=[68.500, 66.632, 70.323],
    to_rgb=True)

rand_range_aug = dict(
    type='RandRangeAug',
    num_policies=2,
    magnitude_level=10,
    policies=[
        dict(type='AutoContrast'),
        dict(type='Brightness', magnitude_key='magnitude', magnitude_range=[0.1, 1.9], prob=0.5),
        dict(type='ColorTransform', magnitude_key='magnitude', magnitude_range=[0.1, 1.9], prob=0.5),
        dict(type='Contrast', magnitude_key='magnitude', magnitude_range=[0.1, 1.9], prob=0.5),
        dict(type='Equalize'),
        dict(type='Identity'),
        dict(type='Posterize', magnitude_key='bits', magnitude_range=[4, 8], prob=0.5),
        dict(type='Rotate', magnitude_key='angle', magnitude_range=[-30, 30], prob=0.5),
        dict(type='Sharpness', magnitude_key='magnitude', magnitude_range=[0.1, 1.9], prob=0.5),
        dict(type='Shear', magnitude_key='magnitude', magnitude_range=[0, 0.3], direction='horizontal', prob=0.5),
        dict(type='Shear', magnitude_key='magnitude', magnitude_range=[0, 0.3], direction='vertical', prob=0.5),
        dict(type='Solarize', magnitude_key='thr', magnitude_range=[0, 256], prob=0.5),
        dict(type='Translate', magnitude_key='magnitude', magnitude_range=[-0.3, 0.3], direction='horizontal',
             prob=0.5),
        dict(type='Translate', magnitude_key='magnitude', magnitude_range=[-0.3, 0.3], direction='vertical',
             prob=0.5),
    ]
)

train_pipelines = [
    dict(type='LoadImageFromFile'),
    dict(type='Resize', size=256, backend='cv2'),
    dict(type='RandomFlip', flip_prob=0.5, direction='horizontal'),
    dict(type='RandomCrop', size=224),
    rand_range_aug,
    dict(type='Normalize', **img_norm_cfg),
    dict(type='ImageToTensor', keys=['img']),
    dict(type='ToTensor', keys=['gt_label']),
    dict(type='Collect', keys=['img', 'gt_label', 'domain_label'])
]

weak_pipelines = [
    dict(type='LoadImageFromFile'),
    dict(type='Resize', size=256, backend='cv2'),
    dict(type='RandomFlip', flip_prob=0.5, direction='horizontal'),
    dict(type='RandomCrop', size=224),
    dict(type='Normalize', **img_norm_cfg),
    dict(type='ImageToTensor', keys=['img']),
    dict(type='ToTensor', keys=['gt_label']),
    dict(type='Collect', keys=['img', 'gt_label', 'domain_label','image_ind'])
]

train_pipelines2 = [
    dict(type='LoadImageFromFile'),
    dict(type='RandomResizedCrop', size=224, backend='cv2'),
    dict(type='RandomFlip', flip_prob=0.5, direction='horizontal'),
    rand_range_aug,
    dict(type='Cutout', shape=16, ),
    dict(type='Normalize', **img_norm_cfg),
    dict(type='ImageToTensor', keys=['img']),
    dict(type='ToTensor', keys=['gt_label']),
    dict(type='Collect', keys=['img', 'gt_label'])
]

test_pipelines = [
    dict(type='LoadImageFromFile'),
    dict(type='Resize', size=256, backend='cv2', ),
    dict(type='CenterCrop', crop_size=224),
    dict(type='Normalize', **img_norm_cfg),
    dict(type='ImageToTensor', keys=['img']),
    dict(type='ToTensor', keys=['gt_label']),
    dict(type='Collect', keys=['img', 'gt_label'])
]

ImageNetA_test_pipelines = [
    dict(type='LoadImageFromFile'),
    dict(type='Resize', size=256, backend='cv2'),
    dict(type='CenterCrop', crop_size=224),
    dict(type='Normalize', **img_norm_cfg),
    dict(type='ImageToTensor', keys=['img']),
    dict(type='ToTensor', keys=['gt_label']),
    dict(type='Collect', keys=['img', 'gt_label'])
]

ImageNetR_test_pipelines = [
    dict(type='LoadImageFromFile'),
    dict(type='Resize', size=256, backend='pillow'),
    dict(type='CenterCrop', crop_size=224),
    dict(type='Normalize', **img_norm_cfg),
    dict(type='ImageToTensor', keys=['img']),
    dict(type='ToTensor', keys=['gt_label']),
    dict(type='Collect', keys=['img', 'gt_label'])
]

ImageNetS_test_pipelines = [
    dict(type='LoadImageFromFile'),
    dict(type='Resize', size=224, backend='pillow'),
    dict(type='CenterCrop', crop_size=224),
    dict(type='Normalize', **img_norm_cfg),
    dict(type='ImageToTensor', keys=['img']),
    dict(type='ToTensor', keys=['gt_label']),
    dict(type='Collect', keys=['img', 'gt_label'])
]

ImageNetv2_test_pipelines = [
    dict(type='LoadImageFromFile'),
    dict(type='Resize', size=268, backend='pillow'),
    dict(type='CenterCrop', crop_size=224),
    dict(type='Normalize', **img_norm_cfg),
    dict(type='ImageToTensor', keys=['img']),
    dict(type='ToTensor', keys=['gt_label']),
    dict(type='Collect', keys=['img', 'gt_label'])
]

source_datasets = dict(
    type=triple_dataset_type,
    name=source_domain,
    split='train',
    pipeline=weak_pipelines,
    pipeline2=weak_pipelines,
    # label_transform=list(range(499)),
    shot_per_class=16,
    builder=dict(
        samples_per_gpu=4,
        persistent_workers=True,
    )
)

target_unlabeled_datasets = dict(
    type=triple_dataset_type,
    name=target_domain_1,
    split='train',
    pipeline=weak_pipelines,
    pipeline2=train_pipelines2,
    # shot=0,
    # 　min_len=60000,
    builder=dict(
        samples_per_gpu=1,
        persistent_workers=True,
    )
)

target_test_datasets_1 = dict(
    type=single_dataset_type,
    name=target_domain_1,
    split='test',
    pipeline=ImageNetA_test_pipelines,
    label_transform=label_transform_for_A,
    builder=dict(
        samples_per_gpu=2048,
    )
)

target_test_datasets_2 = dict(
    type=single_dataset_type,
    name=target_domain_2,
    split='test',
    pipeline=ImageNetR_test_pipelines,
    label_transform=label_transform_for_R,
    builder=dict(
        samples_per_gpu=2048,
    )
)

target_test_datasets_3 = dict(
    type=single_dataset_type,
    name=target_domain_3,
    split='test',
    pipeline=ImageNetS_test_pipelines,
    label_transform=list(range(998)),
    builder=dict(
        samples_per_gpu=2048,
    )
)

target_test_datasets_4 = dict(
    type=single_dataset_type,
    name=target_domain_4,
    split='test',
    pipeline=ImageNetv2_test_pipelines,
    label_transform=list(range(998)),
    builder=dict(
        samples_per_gpu=2048,
    )
)

target_test_datasets_5 = dict(
    type=single_dataset_type,
    name=target_domain_5,
    split='test',
    pipeline=test_pipelines,
    label_transform=list(range(998)),
    builder=dict(
        samples_per_gpu=2048,
    )
)

train_datasets = {
    'pipeline': train_pipelines,
    0: source_datasets,
}

test_datasets = {
    0: target_test_datasets_1,
    1: target_test_datasets_2,
    2: target_test_datasets_3,
    3: target_test_datasets_4,
    4: target_test_datasets_5,
}

datasets = dict(
    n_workers=6,
    train=train_datasets,
    test=test_datasets,
)
